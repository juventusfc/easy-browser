# DOM 添加 CSS

浏览器将 HTML 构建为 DOM 后，它的信息是不全的。它只包含节点和属性，不包含样式。浏览器还需要将 CSS 规则应用到 DOM 上。

由于 DOM 是渐进式的（流水线工作），选择器的出现顺序，必定跟构建 DOM 树的顺序一致。这是一个 CSS 设计的原则，即保证选择器在 DOM 树构建到当前节点时，已经可以准确判断是否匹配，不需要后续节点信息。

浏览器中，都是先收集到所有的 CSS 规则，然后再应用给 DOM。如果之后读取的流导致 CSS 规则变了，会引起 CSS 规则重新计算，然后重新再应用给 DOM，进而引起重排和重绘。

## 构建 CSS 的抽象语法树

浏览器会将 CSS 经过词法和语法分析，转化为抽象语法树。

## 抽象语法树应用于 DOM

当抽象语法树生成后，根据 CSS 的规则将抽象语法树应用于 DOM。

将 CSS 挂载到 DOM 树上:

1. 收集 CSS 规则

   遇到 `</style>` 时， 将栈顶 children 中的 TextNode 中的 content 加到 CSS 规则里

2. 添加调用

   在生成一个新的 element 的时候，立即添加生成 CSS

3. 获取父元素序列
4. 拆分选择器
5. 计算选择器与元素的匹配关系
6. 在 element 上生成 computedStyle 属性
7. 确定规则覆盖关系
